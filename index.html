<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voucher ·ªêc ƒê√¢y N√®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
    <!-- Firebase App -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
    <style>
        .kaushan-script {
            font-family: 'Kaushan Script', cursive;
            display: flex;
            align-items: center;
        }
        .accent {
            font-family: 'Kaushan Script', cursive;
            font-size: 2rem;
            position: relative;
            top: -15px;
            left: 10px;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-yellow-500 to-yellow-900 p-4">
    <div class="flex flex-wrap justify-center gap-6" id="voucher-container"></div>
    <div class="mt-6">
        <button onclick="startQRScanner()" class="bg-blue-600 text-white p-2 rounded">Qu√©t QR</button>
        <div id="qr-reader" class="mt-4"></div>
        <div id="scan-result" class="mt-4 p-4 rounded hidden">
            <p id="voucher-status" class="text-xl font-bold"></p>
            <p id="voucher-code" class="text-lg"></p>
        </div>
    </div>
    <script>
        // C·∫•u h√¨nh Firebase (ƒêƒÉng k√Ω t·∫°i: https://console.firebase.google.com/)
        // D∆∞·ªõi ƒë√¢y l√† c·∫•u h√¨nh m·∫´u, thay th·∫ø b·∫±ng c·∫•u h√¨nh c·ªßa b·∫°n
        const firebaseConfig = {
        apiKey: "AIzaSyCXZcZRxLC2CiQTXHOZYwLtWsXEJ-LEa84",
        authDomain: "ocdayne.firebaseapp.com",
        databaseURL: "https://ocdayne-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ocdayne",
        storageBucket: "ocdayne.firebasestorage.app",
        messagingSenderId: "1052961794169",
        appId: "1:1052961794169:web:207127d4c0019bdff1cca8",
        measurementId: "G-25T4HYKG3S"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const vouchersRef = database.ref('vouchers');

        const fixedCodes = ["ags34", "83Hga", "ja8S3", "1KzXo", "QmW9p"];
        let voucherCodes = [];

        // T·∫£i d·ªØ li·ªáu voucher t·ª´ Firebase
        function loadVouchers() {
            vouchersRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // N·∫øu d·ªØ li·ªáu t·ªìn t·∫°i tr√™n Firebase, s·ª≠ d·ª•ng n√≥
                    voucherCodes = Object.values(snapshot.val());
                    renderVouchers();
                } else {
                    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu, t·∫°o d·ªØ li·ªáu m·∫´u
                    initializeVouchers();
                }
            }).catch((error) => {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:", error);
                // Trong tr∆∞·ªùng h·ª£p l·ªói, s·ª≠ d·ª•ng localStorage nh∆∞ d·ª± ph√≤ng
                loadFromLocalStorage();
            });
        }

        // T·∫°o d·ªØ li·ªáu voucher ban ƒë·∫ßu
        function initializeVouchers() {
            voucherCodes = fixedCodes.map((code, i) => ({
                code: `#${i + 1} - ocdayne${code}20%`,
                expiryDate: "13/04",
                used: false
            }));

            // L∆∞u v√†o Firebase
            voucherCodes.forEach((voucher, index) => {
                vouchersRef.child(index.toString()).set(voucher);
            });

            // L∆∞u d·ª± ph√≤ng v√†o localStorage
            localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            renderVouchers();
        }

        // T·∫£i t·ª´ localStorage n·∫øu kh√¥ng th·ªÉ k·∫øt n·ªëi Firebase
        function loadFromLocalStorage() {
            voucherCodes = JSON.parse(localStorage.getItem('voucherCodes')) || fixedCodes.map((code, i) => ({
                code: `#${i + 1} - ocdayne${code}20%`,
                expiryDate: "13/04",
                used: false
            }));
            renderVouchers();
        }

        function generateQRCode(text) {
            let qr = new QRious({
                value: `${text}`,
                size: 100
            });
            return qr.toDataURL();
        }

        function renderVouchers() {
            const container = document.getElementById('voucher-container');
            container.innerHTML = "";
            
            voucherCodes.forEach((voucher, index) => {
                const voucherElement = document.createElement("div");
                voucherElement.id = `voucher-${index}`;
                voucherElement.className = `relative w-[600px] h-[250px] bg-yellow-800 p-8 rounded-xl shadow-xl text-left border-4 border-yellow-600 flex items-center justify-between ${voucher.used ? 'opacity-50 bg-gray-700' : ''}`;
                voucherElement.innerHTML = `
                    <div>
                        <h1 class='text-5xl font-bold text-yellow-200 drop-shadow-md leading-tight kaushan-script'>
                            √î<span class="accent">¬¥</span>c ƒë√¢y n√®
                        </h1>
                        <p class='text-lg font-bold text-yellow-300 leading-relaxed mt-2'>C√≥ c∆°m chi√™n m√¨ x√†o ngon l·∫Øm</p>
                        <p class='text-lg font-bold text-yellow-300 leading-relaxed mt-2'>H·∫°n s·ª≠ d·ª•ng: ${voucher.expiryDate}</p>
                        <p class='text-sm italic text-yellow-300 mt-2'>Gi·∫£m 20% t·ªïng gi√° tr·ªã h√≥a ƒë∆°n</p>
                    </div>
                    <div class='flex flex-col items-center'>
                        <div class='p-2 bg-red-700 border-2 border-red-500 rounded-lg cursor-pointer text-center w-[250px]' onclick='useVoucher(${index})' ondblclick='restoreVoucher(${index})'>
                            <p class='text-md font-semibold text-white leading-snug'>Code</p>
                            <p class='text-lg font-bold text-white whitespace-nowrap leading-snug'>${voucher.code}</p>
                        </div>
                        <img src="${generateQRCode(voucher.code)}" class='mt-2' />
                        <div class='mt-4 text-sm text-yellow-300 leading-loose text-center'>
                            <p>üìû Li√™n h·ªá ƒë·∫∑t h√†ng: <span class='font-bold text-white'>0912 498 297</span></p>
                            <p>üìç 133/9, Khu ph·ªë 5, Tam Hi·ªáp, Bi√™n H√≤a</p>
                        </div>
                    </div>
                `;
                container.appendChild(voucherElement);
            });
        }

        function useVoucher(index) {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong b·ªô nh·ªõ
            voucherCodes[index].used = true;
            
            // C·∫≠p nh·∫≠t l√™n Firebase
            vouchersRef.child(index.toString()).update({ used: true });
            
            // C·∫≠p nh·∫≠t localStorage d·ª± ph√≤ng
            localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            
            renderVouchers();
        }

        function restoreVoucher(index) {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong b·ªô nh·ªõ
            voucherCodes[index].used = false;
            
            // C·∫≠p nh·∫≠t l√™n Firebase
            vouchersRef.child(index.toString()).update({ used: false });
            
            // C·∫≠p nh·∫≠t localStorage d·ª± ph√≤ng
            localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            
            renderVouchers();
        }

        function startQRScanner() {
            const html5QrCode = new Html5Qrcode("qr-reader");
            const scanResult = document.getElementById('scan-result');
            const voucherStatus = document.getElementById('voucher-status');
            const voucherCode = document.getElementById('voucher-code');
            
            // Reset v√† hi·ªÉn th·ªã k·∫øt qu·∫£ qu√©t
            scanResult.classList.remove('hidden', 'bg-green-700', 'bg-red-700', 'bg-yellow-700');
            voucherStatus.textContent = 'ƒêang ki·ªÉm tra...';
            voucherCode.textContent = '';
            
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    html5QrCode.stop();
                    
                    // X·ª≠ l√Ω vƒÉn b·∫£n ƒë√£ qu√©t
                    let scannedCode = decodedText;
                    console.log("M√£ QR ƒë√£ qu√©t:", scannedCode);
                    
                    // Ki·ªÉm tra tr·∫°ng th√°i voucher t·ª´ Firebase
                    vouchersRef.once('value').then((snapshot) => {
                        console.log("D·ªØ li·ªáu Firebase:", snapshot.val());
                        
                        if (snapshot.exists()) {
                            const vouchers = Object.values(snapshot.val());
                            const foundVoucher = vouchers.find(v => v.code === scannedCode);
                            
                            if (foundVoucher) {
                                voucherCode.textContent = `M√£: ${foundVoucher.code}`;
                                if (foundVoucher.used) {
                                    scanResult.classList.add('bg-red-700');
                                    voucherStatus.textContent = '‚ùå Voucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!';
                                } else {
                                    scanResult.classList.add('bg-green-700');
                                    voucherStatus.textContent = '‚úÖ Voucher h·ª£p l·ªá!';
                                }
                            } else {
                                scanResult.classList.add('bg-yellow-700');
                                voucherStatus.textContent = '‚ö†Ô∏è Voucher kh√¥ng t√¨m th·∫•y!';
                                voucherCode.textContent = `M√£ qu√©t ƒë∆∞·ª£c: ${scannedCode}`;
                            }
                        } else {
                            console.log("Kh√¥ng c√≥ d·ªØ li·ªáu tr√™n Firebase");
                            
                            // Th·ª≠ d√πng d·ªØ li·ªáu t·ª´ localStorage
                            const localVouchers = JSON.parse(localStorage.getItem('voucherCodes')) || [];
                            const foundVoucher = localVouchers.find(v => v.code === scannedCode);
                            
                            if (foundVoucher) {
                                voucherCode.textContent = `M√£: ${foundVoucher.code}`;
                                if (foundVoucher.used) {
                                    scanResult.classList.add('bg-red-700');
                                    voucherStatus.textContent = '‚ùå Voucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng! (d·ªØ li·ªáu local)';
                                } else {
                                    scanResult.classList.add('bg-green-700');
                                    voucherStatus.textContent = '‚úÖ Voucher h·ª£p l·ªá! (d·ªØ li·ªáu local)';
                                }
                            } else {
                                scanResult.classList.add('bg-yellow-700');
                                voucherStatus.textContent = '‚ö†Ô∏è Voucher kh√¥ng t√¨m th·∫•y!';
                                voucherCode.textContent = `M√£ qu√©t ƒë∆∞·ª£c: ${scannedCode}`;
                            }
                        }
                    }).catch((error) => {
                        console.error("L·ªói khi truy c·∫≠p Firebase:", error);
                        scanResult.classList.add('bg-red-700');
                        voucherStatus.textContent = '‚ùå L·ªói khi ki·ªÉm tra voucher!';
                        voucherCode.textContent = `L·ªói: ${error.message}`;
                    });
                },
                (errorMessage) => {
                    console.error("L·ªói qu√©t QR:", errorMessage);
                    scanResult.classList.add('bg-red-700');
                    voucherStatus.textContent = '‚ùå L·ªói khi qu√©t m√£ QR!';
                    voucherCode.textContent = `L·ªói: ${errorMessage}`;
                }
            ).catch(err => {
                console.error("L·ªói khi kh·ªüi t·∫°o m√°y qu√©t:", err);
                alert("Kh√¥ng th·ªÉ kh·ªüi t·∫°o m√°y qu√©t QR: " + err);
            });
        }

        // T·∫£i voucher khi trang ƒë∆∞·ª£c t·∫£i
        loadVouchers();
    </script>
</body>
</html> 
