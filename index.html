<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Voucher - ·ªêc ƒê√¢y N√®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <!-- Firebase App -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-app-compat.js"></script>
    <!-- Firebase Database -->
    <script src="https://www.gstatic.com/firebasejs/9.19.1/firebase-database-compat.js"></script>
    <!-- Th∆∞ vi·ªán html2canvas ƒë·ªÉ chuy·ªÉn HTML th√†nh ·∫£nh -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Th∆∞ vi·ªán jsPDF ƒë·ªÉ t·∫°o file PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kaushan+Script&display=swap" rel="stylesheet">
    <style>
        .kaushan-script {
            font-family: 'Kaushan Script', cursive;
            display: flex;
            align-items: center;
        }
        .accent {
            font-family: 'Kaushan Script', cursive;
            font-size: 2rem;
            position: relative;
            top: -15px;
            left: 10px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-container, #print-container * {
                visibility: visible;
            }
            #print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-yellow-500 to-yellow-900 p-4">
    <!-- Login Screen -->
    <div id="login-screen" class="w-full max-w-md bg-yellow-800 p-8 rounded-xl shadow-xl border-4 border-yellow-600 flex flex-col items-center justify-center">
        <h1 class='text-4xl font-bold text-yellow-200 drop-shadow-md leading-tight kaushan-script mb-6'>
            √î<span class="accent">¬¥</span>c ƒë√¢y n√®
        </h1>
        <p class="text-white text-center mb-6">ƒêƒÉng nh·∫≠p ƒë·ªÉ qu·∫£n l√Ω voucher</p>
        
        <div class="w-full">
            <div class="mb-4">
                <label class="block text-yellow-200 text-sm font-bold mb-2" for="username">
                    T√™n ƒëƒÉng nh·∫≠p
                </label>
                <input id="username" type="text" class="w-full p-2 rounded bg-yellow-700 text-white border border-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p...">
            </div>
            
            <div class="mb-6">
                <label class="block text-yellow-200 text-sm font-bold mb-2" for="password">
                    M·∫≠t kh·∫©u
                </label>
                <input id="password" type="password" class="w-full p-2 rounded bg-yellow-700 text-white border border-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500" placeholder="Nh·∫≠p m·∫≠t kh·∫©u...">
            </div>
            
            <div id="login-error" class="bg-red-700 text-white p-2 rounded mb-4 hidden">
                T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!
            </div>
            
            <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                ƒêƒÉng nh·∫≠p
            </button>
        </div>
    </div>

    <!-- Main Content - Initially Hidden -->
    <div id="main-content" class="hidden w-full">
        <div class="w-full max-w-7xl mb-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class='text-5xl font-bold text-yellow-200 drop-shadow-md leading-tight kaushan-script'>
                    √î<span class="accent">¬¥</span>c ƒë√¢y n√®
                </h1>
                <button onclick="logout()" class="bg-red-600 text-white p-2 rounded">ƒêƒÉng xu·∫•t</button>
            </div>
            
            <div class="bg-yellow-800 p-4 rounded-xl shadow-xl border-2 border-yellow-600 mb-6">
                <div class="flex flex-wrap gap-4 justify-between items-center">
                    <div class="flex gap-2">
                        <input type="text" id="search-input" placeholder="T√¨m theo m√£..." class="p-2 rounded bg-yellow-700 text-white border border-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                        <button onclick="searchVouchers()" class="bg-blue-600 text-white p-2 rounded">T√¨m</button>
                        <button onclick="resetSearch()" class="bg-gray-600 text-white p-2 rounded">ƒê·∫∑t l·∫°i</button>
                    </div>
                    
                    <div class="flex gap-2 items-center">
                        <label class="text-white">L·ªçc:</label>
                        <select id="filter-select" onchange="filterVouchers()" class="p-2 rounded bg-yellow-700 text-white border border-yellow-600 focus:outline-none">
                            <option value="all">T·∫•t c·∫£</option>
                            <option value="used">ƒê√£ s·ª≠ d·ª•ng</option>
                            <option value="unused">Ch∆∞a s·ª≠ d·ª•ng</option>
                        </select>
                        
                        <button onclick="window.location.href='scanner.html'" class="ml-2 bg-green-600 text-white p-2 rounded">Qu√©t QR</button>
                    </div>
                </div>
                
                <!-- Th√™m c√°c n√∫t xu·∫•t voucher -->
                <div class="flex flex-wrap gap-4 mt-4 justify-center">
                    <button onclick="exportFirstBatchAsImages()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        Xu·∫•t 20 voucher ƒë·∫ßu (·∫¢nh)
                    </button>
                    <button onclick="exportSecondBatchAsPDF()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">
                        Xu·∫•t 20 voucher ti·∫øp theo (PDF)
                    </button>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap justify-center gap-6" id="voucher-container"></div>
        
        <div class="mt-6 flex justify-center gap-2">
            <button id="prev-page" onclick="changePage(-1)" class="bg-blue-600 text-white p-2 rounded">¬´ Tr∆∞·ªõc</button>
            <span id="page-info" class="bg-yellow-800 text-white p-2 rounded">Trang 1/5</span>
            <button id="next-page" onclick="changePage(1)" class="bg-blue-600 text-white p-2 rounded">Sau ¬ª</button>
        </div>
    </div>

    <script>
        // Th√¥ng tin ƒëƒÉng nh·∫≠p (ƒë∆°n gi·∫£n, kh√¥ng b·∫£o m·∫≠t)
        const adminUser = {
            username: "admin",
            password: "ocdayne2024"
        };

        // Ki·ªÉm tra ƒëƒÉng nh·∫≠p
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('login-error');
            
            if (username === adminUser.username && password === adminUser.password) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                // L∆∞u tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
                sessionStorage.setItem('isLoggedIn', 'true');
                
                // T·∫£i d·ªØ li·ªáu voucher
                loadVouchers();
            } else {
                loginError.classList.remove('hidden');
            }
        }
        
        // ƒêƒÉng xu·∫•t
        function logout() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-content').classList.add('hidden');
            
            // X√≥a tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            sessionStorage.removeItem('isLoggedIn');
        }
        
        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi t·∫£i trang
        function checkLoginState() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            
            if (isLoggedIn === 'true') {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                loadVouchers();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
            }
        }

        // C·∫•u h√¨nh Firebase (ƒêƒÉng k√Ω t·∫°i: https://console.firebase.google.com/)
        // D∆∞·ªõi ƒë√¢y l√† c·∫•u h√¨nh m·∫´u, thay th·∫ø b·∫±ng c·∫•u h√¨nh c·ªßa b·∫°n
        const firebaseConfig = {
        apiKey: "AIzaSyCXZcZRxLC2CiQTXHOZYwLtWsXEJ-LEa84",
        authDomain: "ocdayne.firebaseapp.com",
        databaseURL: "https://ocdayne-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "ocdayne",
        storageBucket: "ocdayne.firebasestorage.app",
        messagingSenderId: "1052961794169",
        appId: "1:1052961794169:web:207127d4c0019bdff1cca8",
        measurementId: "G-25T4HYKG3S"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const vouchersRef = database.ref('vouchers');

        // T·∫°o 50 m√£ voucher ng·∫´u nhi√™n
        function generateRandomCode(length) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return result;
        }

        let voucherCodes = [];

        // T·∫£i d·ªØ li·ªáu voucher t·ª´ Firebase
        function loadVouchers() {
            vouchersRef.once('value').then((snapshot) => {
                if (snapshot.exists() && Object.keys(snapshot.val()).length >= 50) {
                    // N·∫øu d·ªØ li·ªáu t·ªìn t·∫°i tr√™n Firebase v√† c√≥ √≠t nh·∫•t 50 voucher, s·ª≠ d·ª•ng n√≥
                    voucherCodes = Object.values(snapshot.val());
                    renderVouchers();
                } else {
                    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu ho·∫∑c c√≥ √≠t h∆°n 50 voucher, t·∫°o d·ªØ li·ªáu m·ªõi
                    initializeVouchers();
                }
            }).catch((error) => {
                console.error("L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ Firebase:", error);
                // Trong tr∆∞·ªùng h·ª£p l·ªói, s·ª≠ d·ª•ng localStorage nh∆∞ d·ª± ph√≤ng
                loadFromLocalStorage();
            });
        }

        // T·∫°o d·ªØ li·ªáu voucher ban ƒë·∫ßu
        function initializeVouchers() {
            // X√≥a d·ªØ li·ªáu c≈© n·∫øu c√≥
            vouchersRef.remove();
            
            voucherCodes = [];
            
            // T·∫°o 50 voucher m·ªõi
            for (let i = 0; i < 50; i++) {
                const randomCode = generateRandomCode(5);
                voucherCodes.push({
                    code: `#${i + 1} - ocdayne${randomCode}20%`,
                    expiryDate: "04/05",
                    used: false
                });
            }

            // L∆∞u v√†o Firebase
            voucherCodes.forEach((voucher, index) => {
                vouchersRef.child(index.toString()).set(voucher);
            });

            // L∆∞u d·ª± ph√≤ng v√†o localStorage
            localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            renderVouchers();
        }

        // T·∫£i t·ª´ localStorage n·∫øu kh√¥ng th·ªÉ k·∫øt n·ªëi Firebase
        function loadFromLocalStorage() {
            voucherCodes = JSON.parse(localStorage.getItem('voucherCodes')) || [];
            if (voucherCodes.length < 50) {
                console.log("T·∫°o voucher m·ªõi v√¨ localStorage kh√¥ng c√≥ ƒë·ªß d·ªØ li·ªáu");
                
                voucherCodes = [];
                // T·∫°o 50 voucher m·ªõi
                for (let i = 0; i < 50; i++) {
                    const randomCode = generateRandomCode(5);
                    voucherCodes.push({
                        code: `#${i + 1} - ocdayne${randomCode}20%`,
                        expiryDate: "04/05",
                        used: false
                    });
                }
                
                // L∆∞u v√†o localStorage
                localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            }
            renderVouchers();
        }

        function generateQRCode(text) {
            // S·ª≠ d·ª•ng t√™n mi·ªÅn GitHub Pages m·∫∑c ƒë·ªãnh thay v√¨ t√™n mi·ªÅn t√πy ch·ªânh
            const baseUrl = "https://thanthanh113366.github.io/ocdayne";
            const url = `${baseUrl}/scanner.html?code=${encodeURIComponent(text)}`;
            
            let qr = new QRious({
                value: url,
                size: 100
            });
            return qr.toDataURL();
        }

        // Bi·∫øn qu·∫£n l√Ω ph√¢n trang v√† t√¨m ki·∫øm
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredVouchers = [];
        
        // H√†m t√¨m ki·∫øm voucher
        function searchVouchers() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            filteredVouchers = voucherCodes.filter(voucher => 
                voucher.code.toLowerCase().includes(searchTerm)
            );
            currentPage = 1;
            renderVouchers();
        }
        
        // H√†m ƒë·∫∑t l·∫°i t√¨m ki·∫øm
        function resetSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('filter-select').value = 'all';
            filteredVouchers = [...voucherCodes];
            currentPage = 1;
            renderVouchers();
        }
        
        // H√†m l·ªçc voucher
        function filterVouchers() {
            const filterValue = document.getElementById('filter-select').value;
            
            if (filterValue === 'all') {
                filteredVouchers = [...voucherCodes];
            } else if (filterValue === 'used') {
                filteredVouchers = voucherCodes.filter(voucher => voucher.used);
            } else if (filterValue === 'unused') {
                filteredVouchers = voucherCodes.filter(voucher => !voucher.used);
            }
            
            currentPage = 1;
            renderVouchers();
        }
        
        // H√†m ƒë·ªïi trang
        function changePage(direction) {
            const totalPages = Math.ceil(filteredVouchers.length / itemsPerPage);
            
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            renderVouchers();
        }

        function renderVouchers() {
            const container = document.getElementById('voucher-container');
            container.innerHTML = "";
            
            // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu l·ªçc, s·ª≠ d·ª•ng to√†n b·ªô voucher
            if (!filteredVouchers || filteredVouchers.length === 0) {
                filteredVouchers = [...voucherCodes];
            }
            
            // T√≠nh to√°n ph√¢n trang
            const totalPages = Math.ceil(filteredVouchers.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredVouchers.length);
            
            // C·∫≠p nh·∫≠t th√¥ng tin trang
            document.getElementById('page-info').textContent = `Trang ${currentPage}/${totalPages > 0 ? totalPages : 1}`;
            document.getElementById('prev-page').disabled = currentPage <= 1;
            document.getElementById('next-page').disabled = currentPage >= totalPages;
            
            // Render c√°c voucher tr√™n trang hi·ªán t·∫°i
            const currentPageVouchers = filteredVouchers.slice(startIndex, endIndex);
            
            currentPageVouchers.forEach((voucher, index) => {
                const voucherElement = document.createElement("div");
                voucherElement.id = `voucher-${startIndex + index}`;
                voucherElement.className = `relative w-[300px] h-[400px] bg-yellow-800 p-4 rounded-xl shadow-xl text-left border-4 border-yellow-600 flex flex-col justify-between ${voucher.used ? 'opacity-50 bg-gray-700' : ''}`;
                voucherElement.innerHTML = `
                    <div>
                        <h1 class='text-3xl font-bold text-yellow-200 drop-shadow-md leading-tight kaushan-script'>
                            √î<span class="accent" style="font-size:1.5rem;top:-10px;">¬¥</span>c ƒë√¢y n√®
                        </h1>
                        <p class='text-md font-bold text-yellow-300 leading-relaxed mt-2'>C√≥ c∆°m chi√™n m√¨ x√†o ngon l·∫Øm</p>
                        <p class='text-md font-bold text-yellow-300 leading-relaxed mt-2'>H·∫°n s·ª≠ d·ª•ng: ${voucher.expiryDate}</p>
                        <p class='text-sm italic text-yellow-300 mt-2'>Gi·∫£m 20% t·ªïng gi√° tr·ªã h√≥a ƒë∆°n</p>
                    </div>
                    <div class='flex flex-col items-center'>
                        <div class='p-2 bg-red-700 border-2 border-red-500 rounded-lg cursor-pointer text-center w-full' onclick='useVoucher(${voucherCodes.findIndex(v => v.code === voucher.code)})' ondblclick='restoreVoucher(${voucherCodes.findIndex(v => v.code === voucher.code)})'>
                            <p class='text-sm font-semibold text-white leading-snug'>Code</p>
                            <p class='text-md font-bold text-white leading-snug break-all'>${voucher.code}</p>
                        </div>
                        <img src="${generateQRCode(voucher.code)}" class='mt-2 w-24 h-24' />
                        <div class='mt-2 text-xs text-yellow-300 leading-loose text-center'>
                            <p>üìû Li√™n h·ªá ƒë·∫∑t h√†ng: <span class='font-bold text-white'>0912 498 297</span></p>
                            <p>üìç 133/9, Khu ph·ªë 5, Tam Hi·ªáp, Bi√™n H√≤a</p>
                        </div>
                    </div>
                `;
                container.appendChild(voucherElement);
            });
        }

        function useVoucher(index) {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong b·ªô nh·ªõ
            voucherCodes[index].used = true;
            
            // C·∫≠p nh·∫≠t l√™n Firebase
            vouchersRef.child(index.toString()).update({ used: true });
            
            // C·∫≠p nh·∫≠t localStorage d·ª± ph√≤ng
            localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            
            renderVouchers();
        }

        function restoreVoucher(index) {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i trong b·ªô nh·ªõ
            voucherCodes[index].used = false;
            
            // C·∫≠p nh·∫≠t l√™n Firebase
            vouchersRef.child(index.toString()).update({ used: false });
            
            // C·∫≠p nh·∫≠t localStorage d·ª± ph√≤ng
            localStorage.setItem('voucherCodes', JSON.stringify(voucherCodes));
            
            renderVouchers();
        }

        // H√†m xu·∫•t 20 voucher ƒë·∫ßu d∆∞·ªõi d·∫°ng ·∫£nh
        async function exportFirstBatchAsImages() {
            // L·∫•y 20 voucher ƒë·∫ßu ti√™n
            const firstBatch = voucherCodes.slice(0, 20);
            
            if (firstBatch.length === 0) {
                alert('Kh√¥ng c√≥ voucher n√†o ƒë·ªÉ xu·∫•t!');
                return;
            }
            
            // T·∫°o container t·∫°m th·ªùi ƒë·ªÉ render voucher
            const tempContainer = document.createElement('div');
            tempContainer.className = 'hidden';
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px';
            tempContainer.style.top = '0';
            document.body.appendChild(tempContainer);
            
            // ƒê·∫øm s·ªë l∆∞·ª£ng t·∫£i xu·ªëng th√†nh c√¥ng
            let downloadCount = 0;
            
            // Th√¥ng b√°o b·∫Øt ƒë·∫ßu
            alert('Chu·∫©n b·ªã xu·∫•t 20 voucher ƒë·∫ßu. M·ªói voucher s·∫Ω ƒë∆∞·ª£c t·∫£i xu·ªëng l·∫ßn l∆∞·ª£t.');
            
            // X·ª≠ l√Ω t·ª´ng voucher
            for (let i = 0; i < firstBatch.length; i++) {
                const voucher = firstBatch[i];
                
                // T·∫°o voucher element
                const voucherElement = document.createElement('div');
                voucherElement.id = `export-voucher-${i}`;
                voucherElement.className = 'relative w-[600px] h-[300px] bg-yellow-800 p-6 rounded-xl shadow-xl text-left border-4 border-yellow-600 flex items-center justify-between';
                voucherElement.style.backgroundColor = '#92400e'; // ƒê·∫£m b·∫£o c√≥ m√†u n·ªÅn
                voucherElement.style.width = '600px';
                voucherElement.style.height = '300px';
                voucherElement.style.borderRadius = '12px';
                voucherElement.style.border = '4px solid #b45309';
                voucherElement.style.padding = '24px';
                voucherElement.style.display = 'flex';
                voucherElement.style.alignItems = 'center';
                voucherElement.style.justifyContent = 'space-between';
                
                voucherElement.innerHTML = `
                    <div style="color: #fde68a;">
                        <h1 style="font-size: 28px; font-weight: bold; margin-bottom: 8px; font-family: 'Kaushan Script', cursive;">
                            ·ªêc ƒë√¢y n√®
                        </h1>
                        <p style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">C√≥ c∆°m chi√™n m√¨ x√†o ngon l·∫Øm</p>
                        <p style="font-size: 16px; font-weight: bold; margin-bottom: 4px;">H·∫°n s·ª≠ d·ª•ng: ${voucher.expiryDate}</p>
                        <p style="font-size: 14px; font-style: italic;">Gi·∫£m 20% t·ªïng gi√° tr·ªã h√≥a ƒë∆°n</p>
                    </div>
                    <div style="display: flex; flex-direction: column; align-items: center;">
                        <div style="background-color: #b91c1c; border: 2px solid #ef4444; border-radius: 8px; padding: 12px; text-align: center; width: 280px;">
                            <p style="color: white; font-size: 14px; font-weight: 600;">Code</p>
                            <p style="color: white; font-size: 18px; font-weight: bold; word-break: break-all;">${voucher.code}</p>
                        </div>
                        <img src="${generateQRCode(voucher.code)}" style="margin-top: 12px; width: 128px; height: 128px;" />
                        <div style="margin-top: 8px; font-size: 12px; color: #fde68a; text-align: center;">
                            <p>üìû Li√™n h·ªá ƒë·∫∑t h√†ng: <span style="font-weight: bold; color: white;">0912 498 297</span></p>
                            <p>üìç 133/9, Khu ph·ªë 5, Tam Hi·ªáp, Bi√™n H√≤a</p>
                        </div>
                    </div>
                `;
                
                tempContainer.appendChild(voucherElement);
                
                try {
                    // Chuy·ªÉn ƒë·ªïi voucher th√†nh ·∫£nh v·ªõi background c·ª• th·ªÉ
                    const canvas = await html2canvas(voucherElement, {
                        scale: 2, // T·ªâ l·ªá cao h∆°n cho ·∫£nh r√µ n√©t
                        backgroundColor: '#92400e', // ƒê·∫£m b·∫£o c√≥ background
                        useCORS: true,
                        logging: true,
                        letterRendering: true
                    });
                    
                    // Chuy·ªÉn canvas th√†nh blob thay v√¨ data URL
                    canvas.toBlob(function(blob) {
                        const downloadLink = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        downloadLink.href = url;
                        downloadLink.download = `voucher-${i+1}-${voucher.code.replace(/[^a-zA-Z0-9]/g, '')}.png`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        URL.revokeObjectURL(url);
                        downloadCount++;
                        
                        // Th√¥ng b√°o khi ho√†n th√†nh t·∫•t c·∫£
                        if (downloadCount === firstBatch.length) {
                            alert(`ƒê√£ xu·∫•t ${downloadCount} voucher th√†nh c√¥ng!`);
                        }
                    }, 'image/png', 1.0);
                    
                    // X√≥a voucher element
                    tempContainer.removeChild(voucherElement);
                } catch (error) {
                    console.error(`L·ªói khi xu·∫•t voucher ${i+1}:`, error);
                }
            }
            
            // X√≥a container t·∫°m sau khi ho√†n th√†nh
            setTimeout(() => {
                document.body.removeChild(tempContainer);
            }, 5000);
        }
        
        // H√†m xu·∫•t 20 voucher ti·∫øp theo d∆∞·ªõi d·∫°ng PDF
        async function exportSecondBatchAsPDF() {
            try {
                // Th√¥ng b√°o b·∫Øt ƒë·∫ßu
                alert('ƒêang chu·∫©n b·ªã xu·∫•t voucher sang PDF. Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i gi√¢y.');
                
                // ƒê·∫£m b·∫£o jsPDF ƒë∆∞·ª£c t·∫£i
                if (typeof window.jspdf === 'undefined') {
                    alert('Th∆∞ vi·ªán jsPDF ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng t·∫£i l·∫°i trang v√† th·ª≠ l·∫°i.');
                    return;
                }
                
                // Kh·ªüi t·∫°o jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4',
                    compress: true
                });
                
                // L·∫•y 20 voucher ti·∫øp theo
                const secondBatch = voucherCodes.slice(20, 40);
                
                if (secondBatch.length === 0) {
                    alert('Kh√¥ng c√≥ ƒë·ªß voucher ƒë·ªÉ xu·∫•t!');
                    return;
                }
                
                // T·∫°o container t·∫°m th·ªùi ƒë·ªÉ render voucher
                const tempContainer = document.createElement('div');
                tempContainer.id = 'print-container';
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                tempContainer.style.width = '210mm';
                tempContainer.style.backgroundColor = 'white';
                document.body.appendChild(tempContainer);
                
                // K√≠ch th∆∞·ªõc voucher v√† s·ªë l∆∞·ª£ng tr√™n trang
                const voucherPerPage = 4;
                const totalPages = Math.ceil(secondBatch.length / voucherPerPage);
                
                // T·∫°o t·ª´ng trang
                for (let page = 0; page < totalPages; page++) {
                    // T√≠nh to√°n voucher tr√™n trang hi·ªán t·∫°i
                    const startIndex = page * voucherPerPage;
                    const endIndex = Math.min(startIndex + voucherPerPage, secondBatch.length);
                    const pageVouchers = secondBatch.slice(startIndex, endIndex);
                    
                    // X√≥a n·ªôi dung container tr∆∞·ªõc ƒë√≥
                    tempContainer.innerHTML = '';
                    
                    // T·∫°o layout cho trang v·ªõi background m√†u tr·∫Øng
                    const pageElement = document.createElement('div');
                    pageElement.style.width = '210mm';
                    pageElement.style.height = '297mm';
                    pageElement.style.backgroundColor = '#ffffff';
                    pageElement.style.padding = '10mm';
                    pageElement.style.boxSizing = 'border-box';
                    pageElement.style.display = 'flex';
                    pageElement.style.flexDirection = 'column';
                    pageElement.style.gap = '5mm';
                    
                    pageVouchers.forEach((voucher, i) => {
                        const voucherElement = document.createElement('div');
                        voucherElement.style.width = '190mm';
                        voucherElement.style.height = '65mm';
                        voucherElement.style.backgroundColor = '#92400e';
                        voucherElement.style.borderRadius = '3mm';
                        voucherElement.style.border = '2mm solid #b45309';
                        voucherElement.style.padding = '5mm';
                        voucherElement.style.boxSizing = 'border-box';
                        voucherElement.style.display = 'flex';
                        voucherElement.style.alignItems = 'center';
                        voucherElement.style.justifyContent = 'space-between';
                        
                        voucherElement.innerHTML = `
                            <div style="color: #fde68a; width: 60%;">
                                <h2 style="font-size: 6mm; font-weight: bold; margin-bottom: 2mm;">·ªêc ƒë√¢y n√®</h2>
                                <p style="font-size: 3.5mm; margin-bottom: 1mm;">C√≥ c∆°m chi√™n m√¨ x√†o ngon l·∫Øm</p>
                                <p style="font-size: 3.5mm; margin-bottom: 1mm;">H·∫°n s·ª≠ d·ª•ng: ${voucher.expiryDate}</p>
                                <p style="font-size: 3mm; font-style: italic;">Gi·∫£m 20% t·ªïng gi√° tr·ªã h√≥a ƒë∆°n</p>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; width: 40%;">
                                <div style="background-color: #b91c1c; border: 1mm solid #ef4444; border-radius: 2mm; padding: 2mm; text-align: center; width: 100%;">
                                    <p style="color: white; font-size: 3mm;">Code</p>
                                    <p style="color: white; font-size: 4mm; font-weight: bold; word-break: break-all;">${voucher.code}</p>
                                </div>
                                <img src="${generateQRCode(voucher.code)}" style="width: 25mm; height: 25mm; margin-top: 2mm;" />
                                <div style="margin-top: 1mm; font-size: 2.5mm; color: #fde68a; text-align: center;">
                                    <p>üìû Li√™n h·ªá ƒë·∫∑t h√†ng: <span style="font-weight: bold; color: white;">0912 498 297</span></p>
                                    <p>üìç 133/9, Khu ph·ªë 5, Tam Hi·ªáp, Bi√™n H√≤a</p>
                                </div>
                            </div>
                        `;
                        
                        pageElement.appendChild(voucherElement);
                    });
                    
                    tempContainer.appendChild(pageElement);
                    
                    // Chuy·ªÉn ƒë·ªïi HTML sang canvas
                    const canvas = await html2canvas(pageElement, {
                        scale: 2, // T·ªâ l·ªá cao h∆°n cho PDF r√µ n√©t
                        backgroundColor: '#ffffff', // N·ªÅn tr·∫Øng cho PDF
                        useCORS: true,
                        logging: true,
                        letterRendering: true
                    });
                    
                    // Th√™m ·∫£nh v√†o PDF
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    
                    // Th√™m trang m·ªõi (tr·ª´ trang ƒë·∫ßu ti√™n)
                    if (page > 0) {
                        pdf.addPage();
                    }
                    
                    // Th√™m ·∫£nh v√†o PDF
                    pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
                }
                
                // X√≥a container t·∫°m
                document.body.removeChild(tempContainer);
                
                // L∆∞u file PDF
                pdf.save('vouchers-ocdayne.pdf');
                
                // Th√¥ng b√°o k·∫øt th√∫c
                alert(`ƒê√£ xu·∫•t ${secondBatch.length} voucher th√†nh c√¥ng v√†o file PDF!`);
            } catch (error) {
                console.error("L·ªói khi t·∫°o PDF:", error);
                alert("C√≥ l·ªói khi t·∫°o PDF: " + error.message);
            }
        }

        // Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng nh·∫≠p khi trang ƒë∆∞·ª£c t·∫£i
        window.onload = checkLoginState;
    </script>
</body>
</html> 
